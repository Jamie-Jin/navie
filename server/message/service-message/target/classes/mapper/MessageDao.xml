<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jamie.service.message.dao.MessageDao">

    <insert id="insert" parameterType="com.jamie.api.message.entity.MessageEntity">
        insert into `message`
        <trim prefix="(" suffix=")" suffixOverrides=",">
            routing_key, notify_id, body,
        </trim>
        <trim prefix="values(" suffix=")" suffixOverrides=",">
            #{routingKey}, #{notifyId}, #{body},
        </trim>
    </insert>

    <!-- 消息消费成功 -->
    <update id="consumeSuccess" parameterType="com.jamie.api.message.entity.MessageEntity">
        update `message`
        <trim prefix="set" suffixOverrides=",">
            status = 1,
            consume_count = cosume_count + 1,
            update_time = #{updateTime},
        </trim>
        <trim prefix="where" prefixOverrides="and">
            and status = 0
            and notify_id = #{notifyId}
        </trim>
    </update>

    <!-- 消息消费失败 -->
    <update id="consumeFail" parameterType="com.jamie.api.message.entity.MessageEntity">
        update `message`
        <trim prefix="set" suffixOverrides=",">
            status = -1,
            consume_count = consume_count + 1,
            update_time = #{updateTime},
        </trim>
        <trim prefix="where" prefixOverrides="and">
            and status in (0, 1)
            and notify_id = #{notifyId}
        </trim>
    </update>

</mapper>